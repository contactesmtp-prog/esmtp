
# worker_processes 1;

# events {
#     worker_connections 1024;
# }

# http {
#     include       mime.types;
#     default_type  application/octet-stream;

#     sendfile        on;
#     keepalive_timeout  65;

#     server {
#         listen 80;
#         server_name _;

#         # Main route with fallback to @nextjs
#         location / {
#             proxy_pass         http://app:3000;
#             proxy_http_version 1.1;
#             proxy_set_header   Upgrade $http_upgrade;
#             proxy_set_header   Connection 'upgrade';
#             proxy_set_header   Host $host;
#             proxy_cache_bypass $http_upgrade;

#             # fallback to @nextjs when file not found (for Next.js dynamic routes)
#             try_files $uri $uri/ @nextjs;
#         }

#         # Named location fallback
#         location @nextjs {
#             proxy_pass http://app:3000;
#             proxy_set_header Host $host;
#         }

#         # Next.js build assets
#         location /_next/ {
#             proxy_pass http://app:3000;
#             proxy_set_header Host $host;
#         }

#         # Payload media files
#         location /media/ {
#             proxy_pass http://app:3000;
#             proxy_set_header Host $host;
#         }

#         # Uploads (Payload)
#         location /uploads/ {
#             proxy_pass http://app:3000;
#             proxy_set_header Host $host;
#         }

#         # Optional: for serving public static assets
#         location /assets/ {
#             proxy_pass http://app:3000;
#             proxy_set_header Host $host;
#         }
#     }
# }

worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 80;
        server_name _;

        # Main route with fallback to @nextjs
        location / {
            proxy_pass         http://app-esmtp:3000;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection 'upgrade';
            proxy_set_header   Host $host;
            proxy_cache_bypass $http_upgrade;

            # fallback to @nextjs when file not found (for Next.js dynamic routes)
            try_files $uri $uri/ @nextjs;
        }

        # Named location fallback
        location @nextjs {
            proxy_pass http://app-esmtp:3000;
            proxy_set_header Host $host;
        }

        # Next.js build assets
        location /_next/ {
            proxy_pass http://app-esmtp:3000;
            proxy_set_header Host $host;
        }

        # Payload media files
        location /media/ {
            proxy_pass http://app-esmtp:3000;
            proxy_set_header Host $host;
        }

        # Uploads (Payload)
        location /uploads/ {
            proxy_pass http://app-esmtp:3000;
            proxy_set_header Host $host;
        }

        # Optional: for serving public static assets
        location /assets/ {
            proxy_pass http://app-esmtp:3000;
            proxy_set_header Host $host;
        }
    }
}
